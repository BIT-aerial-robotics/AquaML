# AquaML 框架架构文档

## 概述

AquaML是一个模块化的强化学习框架，专门为机器人学习任务设计。框架名称寓意"像水一样适应各种环境"，采用字典式数据结构和协调器模式，提供统一的组件管理和设备管理能力。

## 架构图

```
AquaML 强化学习框架架构图

┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                    AquaML Framework                                     │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│  ┌─────────────────────────────────────────────────────────────────────────────────────┐│
│  │                            Core - 协调器系统                                        ││
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ││
│  │  │   Coordinator   │  │   Device Info   │  │   Registry      │  │   Tensor Tool   │  ││
│  │  │   全局协调器     │  │   设备管理       │  │   组件注册       │  │   张量工具       │  ││
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘  └─────────────────┘  ││
│  │                                                                                     ││
│  │  ┌─────────────────────────────────────────────────────────────────────────────────┐││
│  │  │                           Managers - 管理器系统                                  │││
│  │  │ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ │││
│  │  │ │Agent Manager│ │Model Manager│ │Environment  │ │Data Manager │ │File System  │ │││
│  │  │ │智能体管理    │ │模型管理      │ │Manager      │ │数据管理      │ │Manager      │ │││
│  │  │ │             │ │             │ │环境管理      │ │             │ │文件系统管理  │ │││
│  │  │ └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘ │││
│  │  │                                                                                 │││
│  │  │ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐                │││
│  │  │ │Communicator │ │Data Unit    │ │Runner       │ │   Plugin    │                │││
│  │  │ │Manager      │ │Manager      │ │Manager      │ │   System    │                │││
│  │  │ │通信管理      │ │数据单元管理  │ │运行器管理    │ │   插件系统   │                │││
│  │  │ └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘                │││
│  │  └─────────────────────────────────────────────────────────────────────────────────┘││
│  └─────────────────────────────────────────────────────────────────────────────────────┘│
│                                                                                         │
│  ┌─────────────────────────────────────────────────────────────────────────────────────┐│
│  │                          Environment - 环境系统                                     ││
│  │  ┌─────────────────┐  ┌─────────────────────────────────────────────────────────────┐││
│  │  │   Base Env      │  │                  Wrappers - 环境包装器                      │││
│  │  │   环境基类       │  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌────────┐ │││
│  │  │                 │  │  │ Gymnasium   │ │ Isaac Lab   │ │    Brax     │ │ Petting│ │││
│  │  │                 │  │  │ Wrapper     │ │ Wrapper     │ │  Wrapper    │ │  Zoo   │ │││
│  │  │                 │  │  │             │ │             │ │             │ │ Wrapper│ │││
│  │  └─────────────────┘  │  └─────────────┘ └─────────────┘ └─────────────┘ └────────┘ │││
│  │                       └─────────────────────────────────────────────────────────────┘││
│  └─────────────────────────────────────────────────────────────────────────────────────┘│
│                                                                                         │
│  ┌─────────────────────────────────────────────────────────────────────────────────────┐│
│  │                          Learning - 学习系统                                        ││
│  │  ┌─────────────────────────────────────────────────────────────────────────────────┐││
│  │  │                           Model - 模型系统                                      │││
│  │  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐                  │││
│  │  │  │   Base Model    │  │  Gaussian Model │  │   Model Config  │                  │││
│  │  │  │   模型基类       │  │  高斯模型        │  │   模型配置       │                  │││
│  │  │  └─────────────────┘  └─────────────────┘  └─────────────────┘                  │││
│  │  └─────────────────────────────────────────────────────────────────────────────────┘││
│  │                                                                                     ││
│  │  ┌─────────────────────────────────────────────────────────────────────────────────┐││
│  │  │                         Memory - 内存系统                                       │││
│  │  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐                  │││
│  │  │  │   Base Memory   │  │Sequential Memory│  │  Random Memory  │                  │││
│  │  │  │   内存基类       │  │  顺序内存        │  │   随机内存       │                  │││
│  │  │  │                 │  │  (在策略算法)    │  │  (离策略算法)    │                  │││
│  │  │  └─────────────────┘  └─────────────────┘  └─────────────────┘                  │││
│  │  └─────────────────────────────────────────────────────────────────────────────────┘││
│  │                                                                                     ││
│  │  ┌─────────────────────────────────────────────────────────────────────────────────┐││
│  │  │                     Reinforcement - 强化学习算法                                │││
│  │  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐                  │││
│  │  │  │   Base Agent    │  │   On-Policy     │  │   Off-Policy    │                  │││
│  │  │  │   智能体基类     │  │   在策略算法     │  │   离策略算法     │                  │││
│  │  │  └─────────────────┘  └─────────────────┘  └─────────────────┘                  │││
│  │  └─────────────────────────────────────────────────────────────────────────────────┘││
│  │                                                                                     ││
│  │  ┌─────────────────────────────────────────────────────────────────────────────────┐││
│  │  │                        Trainers - 训练器系统                                    │││
│  │  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐                  │││
│  │  │  │  Base Trainer   │  │Sequential Trainer│  │  Trainer Config │                  │││
│  │  │  │  训练器基类      │  │  顺序训练器      │  │  训练器配置      │                  │││
│  │  │  └─────────────────┘  └─────────────────┘  └─────────────────┘                  │││
│  │  └─────────────────────────────────────────────────────────────────────────────────┘││
│  └─────────────────────────────────────────────────────────────────────────────────────┘│
│                                                                                         │
│  ┌─────────────────────────────────────────────────────────────────────────────────────┐│
│  │                          Data - 数据处理系统                                        ││
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ││
│  │  │   Base Unit     │  │   Tensor Unit   │  │   NumPy Unit    │  │   Config Status │  ││
│  │  │   数据单元基类   │  │   张量数据单元   │  │   NumPy数据单元  │  │   配置状态       │  ││
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘  └─────────────────┘  ││
│  └─────────────────────────────────────────────────────────────────────────────────────┘│
│                                                                                         │
│  ┌─────────────────────────────────────────────────────────────────────────────────────┐│
│  │                          Config - 配置系统                                          ││
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ││
│  │  │  Config Class   │  │ Config Manager  │  │   Defaults      │  │    Schemas      │  ││
│  │  │  配置类装饰器    │  │  配置管理器      │  │   默认配置       │  │    配置架构      │  ││
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘  └─────────────────┘  ││
│  └─────────────────────────────────────────────────────────────────────────────────────┘│
│                                                                                         │
│  ┌─────────────────────────────────────────────────────────────────────────────────────┐│
│  │                          Utils - 工具模块                                           ││
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ││
│  │  │ Preprocessors   │  │   Schedulers    │  │  TensorBoard    │  │  File System    │  ││
│  │  │ 预处理器         │  │   调度器        │  │  Manager        │  │  文件系统工具    │  ││
│  │  │                 │  │                 │  │  TensorBoard管理 │  │                 │  ││
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘  └─────────────────┘  ││
│  └─────────────────────────────────────────────────────────────────────────────────────┘│
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

## 数据流向图

```
                        ╔══════════════════════════════════════════════════════════════╗
                        ║                    AquaML 数据流架构图                        ║
                        ╚══════════════════════════════════════════════════════════════╝

        ┌─────────────────────────────────────────────────────────────────────────────────┐
        │                           🔄 主要执行循环 (实时交互)                              │
        └─────────────────────────────────────────────────────────────────────────────────┘
                                             
    ┌─────────────────┐  dict(str:numpy/tensor)┌─────────────────┐   dict(str:tensor)   ┌─────────────────┐
    │      环境        │ ─────────────────────▶ │    模型计算      │ ─────────────────── ▶│      环境        │
    │   Environment   │                       │ Model Compute   │                     │   Environment   │
    │                 │◀ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ │                 │                     │                 │
    └─────────────────┘   dict(str:tensor)    └─────────────────┘                     └─────────────────┘
             │                                         │                                         ▲
             │                                         │                                         │
             │ 📥 数据收集                              │ 📥 数据收集                              │
             │                                         │                                         │
             ▼                                         ▼                                         │
    ┌─────────────────┐                       ┌─────────────────┐                               │
    │ 数据单元管理器   │                       │ 数据单元管理器   │                               │
    │ Data Unit Mgr   │                       │ Data Unit Mgr   │                               │
    │  (存储环境数据)  │                       │  (存储动作数据)  │                               │
    │ (num_env,steps, │                       │ (num_env,steps, │                               │
    │     dims)       │                       │     dims)       │                               │
    └─────────────────┘                       └─────────────────┘                               │
             │                                         │                                         │
             │                                         │                                         │
             │ 📊 批量训练数据                          │ 📊 批量训练数据                          │
             │                                         │                                         │
             ▼                                         ▼                                         │
    ┌─────────────────┐                       ┌─────────────────┐                               │
    │     协调器       │◀ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ▶│     协调器       │                               │
    │   Coordinator   │     统一管理           │   Coordinator   │                               │
    └─────────────────┘                       └─────────────────┘                               │
             │                                         │                                         │
             │                                         │                                         │
             ▼                                         ▼                                         │
    ┌─────────────────┐                       ┌─────────────────┐                               │
    │   智能体训练     │                       │   智能体训练     │                               │
    │     Agent       │                       │     Agent       │                               │
    │   🎯 策略学习    │                       │   🎯 价值学习    │                               │
    │  (从data_unit   │                       │  (从data_unit   │                               │
    │   获取训练数据)   │                       │   获取训练数据)   │                               │
    └─────────────────┘                       └─────────────────┘                               │
                                                                                                │
        ┌─────────────────────────────────────────────────────────────────────────────────┐     │
        │                           🔧 环境包装与适配                                      │     │
        └─────────────────────────────────────────────────────────────────────────────────┘     │
                                                                                                │
                                       ┌─────────────────┐                                     │
                                       │   环境包装器     │ ────────────────────────────────────┘
                                       │   Wrappers      │      动作执行返回
                                       │ (Gymnasium,     │
                                       │  Isaac Lab,     │
                                       │  Brax等)        │
                                       └─────────────────┘

        ┌─────────────────────────────────────────────────────────────────────────────────┐
        │  💡 关键特性:                                                                    │
        │  • 执行循环与训练流程完全分离，支持并行运行                                        │
        │  • 数据单元统一管理 (num_env, steps, dims) 格式                                  │
        │  • 支持多环境并行和实时数据收集                                                   │
        │  • 智能体可异步从数据池获取批量训练数据                                           │
        └─────────────────────────────────────────────────────────────────────────────────┘
```

### 核心特性

- **字典式数据架构**: 原生支持复杂的观察和动作空间
- **模块化设计**: 环境、智能体、训练器相互独立，易于扩展
- **协调器模式**: 统一的组件管理和设备管理
- **内存系统**: 通用的内存基类，支持不同算法类型
- **环境兼容性**: 支持多种主流强化学习环境

## 核心组件详解

### 主要组件

#### 1. 协调器系统 (Core)
- 全局设备管理和资源协调
- 组件注册和生命周期管理
- 统一的配置和日志系统

#### 2. 环境系统 (Environment)
- 支持 Gymnasium, Isaac Lab, Brax 等主流环境
- 统一的字典式数据接口
- 自动环境类型检测和包装

#### 3. 学习系统 (Learning)
- **模型系统**: 支持字典式输入输出的神经网络模型
- **内存系统**: 通用内存基类，支持顺序内存（PPO）和随机内存（SAC）
- **强化学习算法**: PPO算法实现，支持GAE、KL自适应学习率
- **训练器**: 顺序训练器，支持并行训练

#### 4. 数据和工具系统
- **数据处理**: 统一的数据格式和自动类型转换
- **配置管理**: 灵活的参数管理和验证
- **工具模块**: 预处理器、调度器、TensorBoard集成等

## 使用示例

```python
# 1. 环境初始化
env = GymnasiumWrapper("Pendulum-v1")

# 2. 模型创建
policy = PendulumPolicy(model_cfg)
value = PendulumValue(model_cfg)
models = {"policy": policy, "value": value}

# 3. 智能体配置
ppo_cfg = PPOCfg()
agent = PPO(models, ppo_cfg)

# 4. 训练执行
trainer_cfg = TrainerConfig(timesteps=10000)
trainer = SequentialTrainer(env, agent, trainer_cfg)
trainer.train()

# 5. 模型保存
agent.save("./trained_model.pt")
```

## 文件结构映射

```
AquaML/
├── core/                    # 协调器系统
│   ├── coordinator.py       # 主协调器
│   ├── coordinator_backup.py # 协调器备份
│   ├── device_info.py       # 设备管理
│   ├── registry.py          # 组件注册
│   ├── tensor_tool.py       # 张量工具
│   ├── exceptions.py        # 异常定义
│   ├── lifecycle.py         # 生命周期管理
│   └── managers/            # 各类管理器
│       ├── agent_manager.py
│       ├── model_manager.py
│       ├── environment_manager.py
│       ├── data_manager.py
│       ├── file_system_manager.py
│       ├── communicator_manager.py
│       ├── data_unit_manager.py
│       └── runner_manager.py
├── environment/             # 环境系统
│   ├── base_env.py          # 环境基类
│   ├── gymnasium_envs.py    # Gymnasium环境
│   ├── gymnasium_vector_envs.py # 向量环境
│   ├── virtual_env.py       # 虚拟环境
│   └── wrappers/            # 环境包装器
│       ├── base.py
│       ├── gymnasium_envs.py
│       ├── isaaclab_envs.py
│       ├── brax_envs.py
│       └── utils.py
├── learning/                # 学习系统
│   ├── base.py              # 学习基类
│   ├── model/               # 模型系统
│   │   ├── base.py
│   │   ├── gaussian.py
│   │   └── model_cfg.py
│   ├── reinforcement/       # 强化学习算法
│   │   ├── base.py          # 智能体基类
│   │   ├── on_policy/       # 在策略算法
│   │   │   └── ppo.py       # PPO算法实现
│   │   └── off_policy/      # 离策略算法（预留扩展）
│   ├── trainers/            # 训练器系统
│   │   ├── base.py
│   │   └── sequential.py
│   └── teacher_student/     # 师生学习框架
├── data/                    # 数据处理系统
│   ├── base_unit.py
│   ├── tensor_unit.py
│   ├── numpy_unit.py
│   └── cfg_status.py
├── config/                  # 配置系统
│   ├── configclass.py
│   ├── manager.py
│   ├── defaults/
│   └── schemas/
├── utils/                   # 工具模块
│   ├── preprocessors.py
│   ├── schedulers.py
│   ├── tensorboard_manager.py
│   ├── array.py
│   ├── dict.py
│   ├── string.py
│   ├── tool.py
│   ├── collector/
│   │   └── concat.py
│   └── file_system/
│       ├── base_file_system.py
│       ├── default_file_system.py
│       └── experiment_utils.py
├── plugin/                  # 插件系统
└── enum.py                  # 枚举定义
```

这个架构设计使得AquaML既保持了简单易用的API，又具备了强大的扩展能力和环境兼容性，特别适合机器人学习任务的需求。